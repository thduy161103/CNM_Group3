<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="shortcut icon"
      href="https://cdn-icons-png.flaticon.com/512/833/833314.png"
      type="image/png"
    />
    <title>Fruit Detector</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #f8f9fa;
      }
      .card {
        border-radius: 1rem;
      }
      button {
        width: 100%;
      }
    </style>
  </head>
  <body class="p-4">
    <nav class="navbar navbar-light bg-white mb-4 shadow-sm">
      <div class="container">
        <a class="navbar-brand" href="#"
          ><i class="bi bi-apple"></i> Fruit Detector</a
        >
      </div>
    </nav>
    <div class="card p-4 shadow-sm bg-white">
      <div class="container">
        <h1 class="mb-4">Fruit Detection</h1>
        <form id="upload-form">
          <input
            type="file"
            id="file-input"
            accept="image/*"
            class="form-control mb-3"
            required
          />
          <button type="submit" class="btn btn-primary">Detect Fruit</button>
        </form>
        <!-- message placeholder -->
        <div id="message" class="mt-3"></div>
        <div class="mt-4">
          <canvas id="canvas"></canvas>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("upload-form");
      const fileInput = document.getElementById("file-input");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const msg = document.getElementById("message");

      form.onsubmit = async (e) => {
        e.preventDefault();
        msg.innerHTML = ""; // xóa thông báo cũ

        const file = fileInput.files[0];
        if (!file) return;
        // draw original image
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await new Promise((r) => (img.onload = r));
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        // upload
        const data = new FormData();
        data.append("file", file);
        const res = await fetch("/upload", { method: "POST", body: data });
        const { predictions } = await res.json();

        if (predictions.length === 0) {
          msg.innerHTML =
            '<div class="alert alert-info">No objects detected</div>';
        }

        // draw boxes
        ctx.lineWidth = 2;
        ctx.font = "18px Arial";
        predictions.forEach((p) => {
          const { xmin, ymin, xmax, ymax, name, confidence } = p;
          ctx.strokeStyle = "red";
          ctx.strokeRect(xmin, ymin, xmax - xmin, ymax - ymin);
          ctx.fillStyle = "red";
          const label = `${name} ${(confidence * 100).toFixed(1)}%`;
          ctx.fillText(label, xmin + 4, ymin + 20);
        });
      };
    </script>
  </body>
</html>
